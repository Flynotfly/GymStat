services:
    db:
        image: postgres:16.2
        restart: always
        volumes:
            - ./data/db:/var/lib/postgresql/data
        environment:
            - POSTGRES_DB=postgres
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
    
    cache:
        image: redis:7.2.4
        restart: always
        volumes:
            - ./data/cache:/data
            
    web:
        build:
            context: ./gymstat
            dockerfile: Dockerfile
        command: ["./wait-for-it.sh", "db:5432", "--", "uwsgi", "--ini", "/code/config/uwsgi/uwsgi.ini"]
        restart: always
        volumes:
            - ./config/uwsgi:/code/config/uwsgi
            - uwsgi_socket:/run/uwsgi
        environment:
            - DJANGO_SETTINGS_MODULE=gymstat.settings.prod
            - POSTGRES_DB=postgres
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
        depends_on:
            - db
            - cache
        
    nginx:
        build:
            context: .
            dockerfile: docker/nginx.Dockerfile
        restart: always
        volumes:
            - uwsgi_socket:/run/uwsgi:ro
            - /etc/letsencrypt:/etc/letsencrypt:ro
        ports:
            - "80:80"
            - "443:443"

volumes:
    uwsgi_socket: